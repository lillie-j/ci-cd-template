name: Docker Build
description: Builds a Docker Image

inputs:
  docker-context-path:
    description: The folder (path written relative to repo root) in which the Dockerfile/build context
    required: true
  build-platform:
    description: Target platform for your docker image (defaults to linux/amd64)
    required: false
    default: "linux/amd64"
  cloud-registry:
    description: Cloud container registry to push to (azure, aws)
    required: false
    default: "none"
  AWS_ACCESS_KEY_ID:
    description: AWS Access Key (Hosted in GitHub Secrets)
    required: false
  AWS_SECRET_ACCESS_KEY:
    description: AWS Secret Access Key (Hosted in GitHub Secrets)
    required: false
  AWS_REGION:
    description: AWS Region of Account (Hosted in GitHub Secrets)
    required: false
  ACR_LOGIN_SERVER:
    description: Azure ACR Login Server
  ACR_USERNAME:
    description: Azure ACR Username
    required: false
  ACR_PASSWORD:
    description: Azure ACR password
    required: false


runs:
  using: composite
  steps:
# Cloud Agnostic (Docker Setup & Tag Generation)
  - name: Validate Docker Context Path
    shell: bash
    run: |
      "$GITHUB_ACTION_PATH/scripts/validate_docker_context.sh" \
      "${{ inputs.docker-context-path }}"

  - name: Set up Docker
    uses: docker/setup-buildx-action@v2

  - name: Generate Docker Tag
    id: set_tag
    shell: bash
    run: |
      SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
      BUILD_CONTEXT_RELATIVE_FOLDER=$(basename "${{ inputs.docker-context-path }}")
      REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
      TAG="${REPO_NAME}-${BUILD_CONTEXT_RELATIVE_FOLDER}:${SHORT_SHA}"
      LATEST_TAG="${REPO_NAME}-${BUILD_CONTEXT_RELATIVE_FOLDER}:latest"
      FILESYSTEM_FRIENDLY_TAG="${REPO_NAME}-${BUILD_CONTEXT_RELATIVE_FOLDER}-${SHORT_SHA}"

      echo "Generated Tag: $TAG"
      echo "TAG=$TAG" >> $GITHUB_ENV
      echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
      echo "FILESYSTEM_FRIENDLY_TAG=$FILESYSTEM_FRIENDLY_TAG" >> $GITHUB_ENV

# AWS Build & Push  
  - name: Configure AWS credentials
    if: ${{ inputs.cloud-registry =='aws' }}
    uses: aws-actions/configure-aws-credentials@v4
    with:
      aws-access-key-id: ${{ inputs.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ inputs.AWS_SECRET_ACCESS_KEY }}
      aws-region: ${{ inputs.AWS_REGION }}

  - name: Login to ECR
    if: ${{ inputs.cloud-registry == 'aws' }}
    id: login-ecr
    uses:  aws-actions/amazon-ecr-login@v2

  - name: Build and tag Docker image (AWS)
    if: ${{ inputs.cloud-registry == 'aws' }}
    shell: bash
    run: |
      ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
  
      docker buildx build \
        --platform "${{ inputs.build-platform }}" \
        --tag "$ECR_REGISTRY/${{ env.TAG }}" \
        --tag "$ECR_REGISTRY/${{ env.LATEST_TAG }}" \
        --file "${{ inputs.docker-context-path }}/Dockerfile" \
        "${{ inputs.docker-context-path }}" \
        --load

      docker push "$ECR_REGISTRY/${{ env.TAG }}"
      docker push "$ECR_REGISTRY/${{ env.LATEST_TAG }}"

# Azure Build and Push
  - name: Login to Azure Container Registry
    uses: docker/login-action@v2
    with:
      registry: testing.azurecr.io
      username: ${{ secrets.ACR_USERNAME }}
      password: ${{ secrets.ACR_PASSWORD }}

  - name: Build and tag Docker image (Azure)
    if: ${{ inputs.cloud-registry == 'azure' }}
    shell: bash
    run: |
      ACR_LOGIN_SERVER=testing.azurecr.io
  
      docker buildx build \
        --platform "${{ inputs.build-platform }}" \
        --tag "$ACR_LOGIN_SERVER/${{ env.TAG }}" \
        --tag "$ACR_LOGIN_SERVER/${{ env.LATEST_TAG }}" \
        --file "${{ inputs.docker-context-path }}/Dockerfile" \
        "${{ inputs.docker-context-path }}" \
        --load

      docker push "$ACR_LOGIN_SERVER/${{ env.TAG }}"
      docker push "$ACR_LOGIN_SERVER/${{ env.LATEST_TAG }}"

# Build and Push to GitHub Artifacts as .tar.gz
  - name: Build and tag Docker image
    if: ${{ inputs.cloud-registry == 'none' }}
    shell: bash
    run: |
      docker buildx build \
        --platform "${{ inputs.build-platform }}" \
        --tag "${{ env.FILESYSTEM_FRIENDLY_TAG }}" \
        --file "${{ inputs.docker-context-path }}/Dockerfile" \
        "${{ inputs.docker-context-path }}" \
        --load

      docker save "${{ env.FILESYSTEM_FRIENDLY_TAG }}" -o "${{ env.FILESYSTEM_FRIENDLY_TAG }}.tar"
      gzip "${{ env.FILESYSTEM_FRIENDLY_TAG }}.tar"

  - name: Upload Image
    if: ${{ inputs.cloud-registry == 'none' }}
    uses: actions/upload-artifact@v4
    with:
      name: "${{ env.FILESYSTEM_FRIENDLY_TAG }}"
      path: "${{ env.FILESYSTEM_FRIENDLY_TAG }}.tar.gz"
      if-no-files-found: ignore
