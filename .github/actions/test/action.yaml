name: Run Tests (Pytest)
description: Runs all tests in ./tests using the Pytest Framework. Outputs a Coverage Report (HTML) as an artifact.
inputs:
  folders_for_test_coverage:
    description: Space delimited list of folders, relative to root but no leading './' to test and generate coverage reports for. 
    type: string 

runs:
  using: composite
  steps:
  - name: Run Tests
    shell: bash
    run: "$GITHUB_ACTION_PATH/scripts/run_tests.sh ${{ inputs.folders_for_test_coverage }}"

  - name: Get short SHA
    id: short-sha
    shell: bash
    run: |
      SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
      echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

  - name: Upload Test Coverage Report
    uses: actions/upload-artifact@v4
    with:
      name: "coverage_report-${{ steps.short-sha.outputs.short_sha }}"
      path: htmlcov/
      if-no-files-found: ignore

  - name: Push Coverage Score Badge to Badges Branch
    shell: bash
    run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ inputs.github_token }}@github.com/${{ github.repository }}
        git checkout coverage_report || git checkout --orphan coverage_report
        cp coverage_report.json /tmp/coverage_report.json
        git rm -rf .
        cp /tmp/coverage_report.json .
        git add coverage_report.json
        git commit -m "Update coverage score from ${GITHUB_REF#refs/heads/} commit ${GITHUB_SHA}"
        git push -f origin coverage_report 
        git checkout $GITHUB_REF_NAME

